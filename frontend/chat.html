<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EmoMap ‚Äî Tr√≤ chuy·ªán c·∫£m x√∫c</title>
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/763/763755.png">
  <meta property="og:title" content="EmoMap AI" />
  <meta property="og:description" content="EmoMap - H·ªá th·ªëng AI t∆∞∆°ng t√°c h·ªó tr·ª£ s√†ng l·ªçc s·ªõm b·∫°o l·ª±c h·ªçc ƒë∆∞·ªùng trong tr∆∞·ªùng THPT" />
  <meta property="og:image" content="https://i.ibb.co/q3ymzcdJ/Th-m-ti-u-ph-1.png" />
  <meta property="og:url" content="https://emomap.onrender.com/" />
  <meta property="og:type" content="Website KHKT" />
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">

  <style>
        #chat * {
            overflow: visible !important;
        }

        @keyframes floatArcLeft {
            0%   { transform: translate(0, 0)   rotate(0deg); opacity: 1; }
            100% { transform: translate(-45px, -70px) rotate(-25deg); opacity: 0; }
        }

        .emoji-particle {
            position: absolute;
            font-size: 26px;
            pointer-events: none;
            left: 50%;
            bottom: 20%;
            transform: translateX(-50%);
        }


    body {
      font-family: 'Inter', sans-serif;
    }

    /* Avatar AI breathing */
    .avatar-ai {
      animation: breathing 3s ease-in-out infinite;
    }
    @keyframes breathing {
      0% { transform: scale(1); }
      50% { transform: scale(1.07); }
      100% { transform: scale(1); }
    }

    /* AI typing animation */
    .typing {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 6px 12px;
      background: #e2e8f0;
      border-radius: 20px;
      animation: fadeIn 0.3s ease-out;
    }
    .typing-dot {
      width: 6px;
      height: 6px;
      background: #94a3b8;
      border-radius: 50%;
      animation: bounce 1.3s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); opacity: 0.4; }
      50% { transform: translateY(-6px); opacity: 1; }
    }

    /* Smooth fade-up */
    .fade-up {
      animation: fadeUp 0.6s ease-out;
    }
    @keyframes fadeUp {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    /* Mobile responsive chat height */
    @media (max-width: 640px) {
      #chat {
        height: 65vh !important;
      }
    }

    /* 1. N√∫t n·ªïi (Floating Button) ·ªü g√≥c ph·∫£i */
        .chat-btn-float {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #0084ff; /* M√†u xanh ki·ªÉu Messenger */
            color: white;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 9999;
            font-size: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }

        .chat-btn-float:hover {
            transform: scale(1.1); /* Ph√≥ng to nh·∫π khi di chu·ªôt */
        }

        /* 2. C·ª≠a s·ªï Chat (Ban ƒë·∫ßu ·∫©n ƒëi) */
        .chat-window {
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
            position: fixed;
            bottom: 90px; /* N·∫±m tr√™n n√∫t b·∫•m m·ªôt ch√∫t */
            right: 20px;
            width: 350px; /* Chi·ªÅu r·ªông ti√™u chu·∫©n c·ªßa box chat */
            height: 500px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 9999;
            overflow: hidden;
            flex-direction: column;
            border: 1px solid #ddd;
        }

        /* 3. Thanh ti√™u ƒë·ªÅ c·ªßa c·ª≠a s·ªï chat */
        .chat-header {
            background-color: #0084ff;
            color: white;
            padding: 10px 15px;
            font-family: sans-serif;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-close {
            cursor: pointer;
            font-size: 20px;
        }

        /* 4. Ph·∫ßn th√¢n ch·ª©a Iframe */
        .chat-body {
            flex: 1; /* Chi·∫øm h·∫øt kho·∫£ng tr·ªëng c√≤n l·∫°i */
            height: 100%;
            width: 100%;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Responsive: Tr√™n ƒëi·ªán tho·∫°i th√¨ cho full m√†n h√¨nh ho·∫∑c nh·ªè l·∫°i */
        @media (max-width: 400px) {
            .chat-window {
                width: 90%;
                right: 5%;
                bottom: 90px;
            }
        }

/* (Th√™m v√†o cu·ªëi file style.css) */

/* === CSS CHO TABS === */
/* (Trong file style.css) */

/* === 1. CONTAINER CH·ª®A N√öT (S·ª≠a l·ªói b·ªã l·ªách) === */
.tab-navigation {
    display: flex;
    justify-content: center; /* CƒÉn gi·ªØa tuy·ªát ƒë·ªëi */
    align-items: center;
    gap: 20px; /* Kho·∫£ng c√°ch gi·ªØa 2 n√∫t r·ªông r√£i h∆°n */
    margin: 30px auto; /* T·ª± ƒë·ªông cƒÉn l·ªÅ tr√°i ph·∫£i, c√°ch tr√™n d∆∞·ªõi 30px */
    width: 100%;
    max-width: 600px; /* Gi·ªõi h·∫°n chi·ªÅu r·ªông ƒë·ªÉ kh√¥ng b·ªã lo√£ng tr√™n PC */
}

/* === 2. STYLE CHUNG CHO C·∫¢ 2 N√öT === */
.tab-btn {
    padding: 12px 25px; /* N√∫t to h∆°n, d·ªÖ b·∫•m tr√™n ƒëi·ªán tho·∫°i */
    border: none;
    background-color: #f0f2f5; /* M√†u n·ªÅn x√°m nh·∫°t tinh t·∫ø khi ch∆∞a ch·ªçn */
    color: #64748b; /* M√†u ch·ªØ x√°m ghi hi·ªán ƒë·∫°i */
    border-radius: 50px; /* Bo tr√≤n ho√†n to√†n (d·∫°ng vi√™n thu·ªëc) */
    cursor: pointer;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-weight: 700; /* Ch·ªØ ƒë·∫≠m */
    font-size: 1rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Hi·ªáu ·ª©ng chuy·ªÉn ƒë·ªông m∆∞·ª£t m√† */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); /* B√≥ng nh·∫π */
    
    /* ƒê·ªÉ icon v√† ch·ªØ th·∫≥ng h√†ng */
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Hi·ªáu ·ª©ng khi di chu·ªôt v√†o n√∫t ch∆∞a ch·ªçn */
.tab-btn:hover {
    transform: translateY(-2px); /* N·ªïi l√™n nh·∫π */
    background-color: #e2e8f0;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

/* === 3. TR·∫†NG TH√ÅI "ACTIVE" (ƒêANG CH·ªåN) - PH·∫¶N QUAN TR·ªåNG === */

/* Khi ch·ªçn n√∫t KH·∫¢O S√ÅT -> M√†u Xanh D∆∞∆°ng (Blue Gradient) */
/* Selector n√†y ch·ªçn n√∫t c√≥ class 'active' v√† l√† n√∫t ƒë·∫ßu ti√™n */
.tab-btn.active:first-child {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); /* B√≥ng ph√°t s√°ng m√†u xanh */
    transform: scale(1.05); /* Ph√≥ng to nh·∫π ƒë·ªÉ b√°o hi·ªáu ƒëang ch·ªçn */
}

/* Khi ch·ªçn n√∫t B·ª®C T∆Ø·ªúNG -> M√†u H·ªìng T√≠m (Pink/Purple Gradient) */
/* Selector n√†y ch·ªçn n√∫t c√≥ class 'active' v√† l√† n√∫t th·ª© hai */
.tab-btn.active:last-child {
    background: linear-gradient(135deg, #ec4899 0%, #d946ef 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(217, 70, 239, 0.4); /* B√≥ng ph√°t s√°ng m√†u t√≠m */
    transform: scale(1.05);
}

/* T·ªëi ∆∞u cho ƒëi·ªán tho·∫°i */
@media (max-width: 600px) {
    .tab-navigation {
        gap: 10px; /* Gi·∫£m kho·∫£ng c√°ch tr√™n ƒëi·ªán tho·∫°i */
        padding: 0 10px;
    }
    .tab-btn {
        padding: 10px 15px; /* N√∫t nh·ªè h∆°n x√≠u cho v·ª´a m√†n h√¨nh */
        font-size: 0.9rem;
        flex: 1; /* Chia ƒë·ªÅu chi·ªÅu r·ªông cho 2 n√∫t */
        justify-content: center; /* CƒÉn gi·ªØa n·ªôi dung trong n√∫t */
    }
}
/* === CSS CHO B·ª®C T∆Ø·ªúNG (STICKY NOTES) === */
.wall-input-area {
    background: #fff;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    margin-bottom: 20px;
    text-align: center;
}

.wall-input-area textarea {
    width: 100%;
    height: 80px;
    padding: 10px;
    border: 2px solid #eee;
    border-radius: 8px;
    font-family: inherit;
    margin-bottom: 10px;
    box-sizing: border-box;
}

.btn-post {
    background-color: #ff6b6b;
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
}

.wall-container {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: center;
    padding: 10px;
    min-height: 200px;
}

.sticky-note {
    width: 140px;
    height: 140px;
    padding: 15px;
    box-shadow: 2px 2px 8px rgba(0,0,0,0.15);
    font-family: 'Courier New', monospace; /* Font ch·ªØ vi·∫øt tay gi·∫£ */
    font-size: 0.9rem;
    color: #333;
    overflow-y: auto;
    border-radius: 2px 2px 15px 2px;
    transition: transform 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
}

.sticky-note:hover {
    transform: scale(1.1) rotate(0deg) !important;
    z-index: 10;
    box-shadow: 5px 5px 15px rgba(0,0,0,0.2);
}

/* Mobile responsive cho b·ª©c t∆∞·ªùng */
@media (max-width: 600px) {
    .sticky-note {
        width: 100%; /* Tr√™n ƒëi·ªán tho·∫°i, note full chi·ªÅu r·ªông */
        height: auto;
        min-height: 80px;
    }
}

/* (Th√™m v√†o cu·ªëi file style.css) */

/* === CƒÇN GI·ªÆA N·ªòI DUNG C√ÅC TAB === */

.tab-content {
    width: 100%; /* Chi·∫øm to√†n b·ªô chi·ªÅu r·ªông c√≥ th·ªÉ */
    display: flex; /* S·ª≠ d·ª•ng Flexbox ƒë·ªÉ d√†n trang */
    flex-direction: column; /* X·∫øp c√°c ph·∫ßn t·ª≠ theo chi·ªÅu d·ªçc */
    align-items: center; /* CƒÉn gi·ªØa tr·ª•c d·ªçc -> N·ªôi dung s·∫Ω v√†o gi·ªØa */
}

/* CƒÉn ch·ªânh ri√™ng cho Form Kh·∫£o S√°t */
#emotionForm {
    width: 100%; 
    max-width: 800px; /* Gi·ªõi h·∫°n chi·ªÅu r·ªông ƒë·ªÉ kh√¥ng b·ªã b√® ra qu√° tr√™n m√°y t√≠nh */
    margin: 0 auto; /* CƒÉn gi·ªØa margin (ph∆∞∆°ng √°n d·ª± ph√≤ng) */
}

/* CƒÉn ch·ªânh ri√™ng cho B·ª©c T∆∞·ªùng (ƒë·ªÉ n√≥ kh√¥ng b·ªã l·ªách) */
.wall-input-area {
    width: 100%;
    max-width: 600px; /* B·ª©c t∆∞·ªùng nh·∫≠p li·ªáu nh·ªè g·ªçn h∆°n ch√∫t */
    margin: 0 auto 20px auto;
}

/* ƒê·∫£m b·∫£o container ch√≠nh bao quanh t·∫•t c·∫£ c≈©ng ƒë∆∞·ª£c cƒÉn gi·ªØa */
.container {
    display: flex;
    flex-direction: column;
    align-items: center;
}
  </style>

</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4">


  <div id="myChatWindow" class="chat-window">
        <div class="chat-header">
            <span>H·ªó tr·ª£ tr·ª±c tuy·∫øn</span>
            <span class="chat-close" onclick="toggleChat()">&times;</span>
        </div>
        <div class="chat-body">
            <iframe src="https://emomapv3.onrender.com" title="Chat Content"></iframe>
        </div>
    </div>

    <button class="chat-btn-float" onclick="toggleChat()">
        üí¨
    </button>


  <div class="container">
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('survey')">üìù Kh·∫£o s√°t</button>
            <button class="tab-btn" onclick="switchTab('wall')">üíå B·ª©c T∆∞·ªùng ·∫®n Danh</button>
        </div>

        <div id="tab-survey" class="tab-content active">
                <div class="max-w-2xl w-full fade-up">

    <div class="bg-white/80 backdrop-blur-xl p-6 rounded-3xl shadow-2xl">

      <!-- Header -->
      <header class="flex items-center gap-4 mb-4">
        <div class="w-14 h-14 rounded-full flex items-center justify-center shadow-lg avatar-ai">
          <span class="text-3xl text-white"><img src="https://cdn-icons-png.flaticon.com/512/763/763755.png"  alt=""></span>
        </div>
        <div>
          <h1 class="text-xl font-bold text-slate-800">EmoMap AI</h1>
          <p class="text-sm text-slate-500">Tr√≤ chuy·ªán ‚Äî L·∫Øng nghe ‚Äî Th·∫•u hi·ªÉu c·∫£m x√∫c</p>
        </div>
      </header>

      <!-- Chat messages -->
      <div id="chat"
           class="h-[480px] overflow-y-auto p-4 rounded-2xl bg-slate-50 border shadow-inner space-y-3"></div>

      <!-- Input area -->
      <div id="inputArea" class="mt-4"></div>

    </div>
        </div>

        <div id="tab-wall" class="tab-content" style="display: none;">
            <div class="wall-input-area">
                <h3>G√≥c gi·∫£i t·ªèa: "ƒêi·ªÅu em ch∆∞a d√°m n√≥i"</h3>
                <p>M·ªçi chia s·∫ª ƒë·ªÅu ·∫©n danh. AI s·∫Ω ch·ªçn m√†u s·∫Øc cho t√¢m tr·∫°ng c·ªßa b·∫°n.</p>
                <textarea id="noteInput" placeholder="Vi·∫øt t√¢m s·ª± c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea>
                <button type="button" class="btn-post" onclick="postNote()">D√°n l√™n t∆∞·ªùng</button>
            </div>
            
            <div id="wall-container" class="wall-container">
                <p style="text-align:center; color:#666;">ƒêang t·∫£i t√¢m s·ª±...</p>
            </div>
        </div>

    </div>
  

  </div>

  <!-- MAIN SCRIPT -->
  <script>
    /********************************************
     *   EMOJI MAPPING CHO t·ª´ng m·ª©c Likert 1‚Äì5
     ********************************************/
    const likertEmoji = {
      1: { icon: "üò¢", text: "Bu·ªìn b√£" },
      2: { icon: "üòï", text: "Kh√¥ng vui" },
      3: { icon: "üôÇ", text: "B√¨nh th∆∞·ªùng" },
      4: { icon: "üòä", text: "Vui v·∫ª" },
      5: { icon: "ü§©", text: "R·∫•t vui / H√†o h·ª©ng" }
    };

    /********************************************
     *  B·∫ÆT ƒê·∫¶U M√É LOGIC (gi·ªØ nguy√™n)
     ********************************************/
    const chatEl = document.getElementById("chat");
    const inputArea = document.getElementById("inputArea");

    const infoQuestions = [
      { id: "name", type: "text", question: "Ch√†o b·∫°n! Cho m√¨nh bi·∫øt t√™n c·ªßa b·∫°n nh√©?" },
      { id: "class", type: "text", question: "B·∫°n ƒëang h·ªçc l·ªõp n√†o?" },
      { id: "gender", type: "choice", question: "Gi·ªõi t√≠nh c·ªßa b·∫°n l√† g√¨?", choices: ["Nam","N·ªØ","Kh√°c","Kh√¥ng mu·ªën ti·∫øt l·ªô"] }
    ];

    const likertGroups = [
      {
        group: "I. C·∫£m x√∫c t√≠ch c·ª±c trong h·ªçc t·∫≠p",
        questions: [
          "T√¥i c·∫£m th·∫•y ... khi tham gia c√°c ti·∫øt h·ªçc tr√™n l·ªõp.",
          "T√¥i c·∫£m th·∫•y ... khi ƒë·∫øn tr∆∞·ªùng m·ªói ng√†y."
        ]
      },
      {
        group: "II. C·∫£m x√∫c ti√™u c·ª±c trong h·ªçc ƒë∆∞·ªùng",
        questions: [
          "T√¥i c·∫£m th·∫•y ... khi ch·ª©ng ki·∫øn b·∫°o l·ª±c h·ªçc ƒë∆∞·ªùng.",
          "T√¥i c·∫£m th·∫•y ... khi giao ti·∫øp v·ªõi b·∫°n b√® trong l·ªõp."
        ]
      },
      {
        group: "III. C·∫£m x√∫c khi c√≥ th·ªÉ chia s·∫ª",
        questions: [
          "T√¥i c·∫£m th·∫•y ... khi c√≥ ·ª©ng d·ª•ng ghi l·∫°i c·∫£m x√∫c h·∫±ng ng√†y.",
          "T√¥i c·∫£m th·∫•y ... khi chia s·∫ª c·∫£m x√∫c c·ªßa m√¨nh ƒë·ªëi v·ªõi ng∆∞·ªùi kh√°c."
        ]
      },
      {
        group: "IV. C·∫£m x√∫c v·ªÅ b·∫£n th√¢n",
        questions: [
          "T√¥i c·∫£m th·∫•y ... v·ªõi b·∫£n th√¢n m√¨nh.",
          "T√¥i c·∫£m th·∫•y ... v·ªÅ kh·∫£ nƒÉng c·ªßa b·∫£n th√¢n."
        ]
      }
    ];
    const finalMessagePrompt = "N·∫øu c√≥ ƒëi·ªÅu g√¨ khi·∫øn b·∫°n vui/bu·ªìn/lo l·∫Øng h√¥m nay, h√£y chia s·∫ª v·ªõi m√¨nh nh√©.";

    const likertQuestions = likertGroups.flatMap(
      g => g.questions.map(q => ({ group: g.group, text: q }))
    );

    let state = {
      step: 0, infoIndex: 0, likertIndex: 0,
      responses: {}
    };

    /********************************************
     *  CHAT UI RENDER FUNCTIONS
     ********************************************/
    function scrollToBottom() {
      setTimeout(() => { try { chatEl.scrollTop = chatEl.scrollHeight; } catch(e){} }, 10);
    }

    function botTyping() {
      const wrap = document.createElement("div");
      wrap.className = "max-w-[70%]";
      wrap.innerHTML = `
        <div class="typing shadow-md">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>`;
      chatEl.appendChild(wrap);
      scrollToBottom();
      return wrap;
    }

    function createBotBubbleContainer() {
      const wrapper = document.createElement("div");
      wrapper.className = "max-w-[80%]";
      const bubble = document.createElement("div");
      bubble.className = "p-3 rounded-2xl bg-blue-100 text-slate-800 shadow";
      wrapper.appendChild(bubble);
      chatEl.appendChild(wrapper);
      scrollToBottom();
      return { wrapper, bubble };
    }
function botMessage(text, { speed = 18, immediate = false } = {}) {
      text = String(text || "");
      const isHTML = /<\/?[a-z][\s\S]*>/i.test(text); 
      const { wrapper, bubble } = createBotBubbleContainer();

      if (immediate || isHTML) {
          bubble.innerHTML = text;
          scrollToBottom();
          return Promise.resolve();
      }

      return new Promise((resolve) => {
        bubble.innerHTML = ""; // start empty
        let i = 0;

        // optional: show typing indicator first, then replace it
        const typingIndicator = document.createElement("span");
        typingIndicator.className = "inline-flex items-center gap-1";
        typingIndicator.innerHTML = `<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`;
        bubble.appendChild(typingIndicator);
        scrollToBottom();

        // small delay so user sees typing dots
        setTimeout(function typeChar() {
          // remove typing indicator on first character
          if (i === 0) bubble.innerHTML = "";

          if (i < text.length) {
            // append next character
            bubble.innerHTML += text.charAt(i);
            i++;
            scrollToBottom();
            // schedule next char
            setTimeout(typeChar, speed);
          } else {
            // done
            resolve();
          }
        }, 250); // typing indicator visible 250ms before start
      });
    }
    /*
    function botMessage(text){
      const w = document.createElement("div");
      w.className = "max-w-[80%]";
      w.innerHTML = `<div class="p-3 rounded-2xl bg-blue-100 text-slate-800 shadow">${text}</div>`;
      chatEl.appendChild(w);
      scrollToBottom();
    }
    */

function userMessage(text, reactionEmoji = null) {
    const avatar = localStorage.getItem("student_avatar") || "üßë";

    const wrapper = document.createElement("div");
    wrapper.className = "flex justify-end items-start gap-2 relative overflow-visible";

    wrapper.innerHTML = `
        <div class="p-3 rounded-2xl bg-blue-600 text-white shadow max-w-[75%]">
        ${text}
        </div>

            <div class="relative overflow-visible flex-shrink-0">
            <div class="w-12 h-12 rounded-full flex items-center justify-center shadow-md">
                <span class="text-3xl leading-none flex items-center justify-center">
                    ${avatar}
                </span>
            </div>
            <div class="particle-zone absolute bottom-0 right-0 overflow-visible"></div>
            </div>
    `;

    chatEl.appendChild(wrapper);
    scrollToBottom();

    // HI·ªÜU ·ª®NG PH√ÅO HOA (ƒë·ªëi v·ªõi c√¢u th√¥ng tin c√° nh√¢n)
    if (reactionEmoji === "firework") {
        confetti({
        particleCount: 60,
        spread: 75,
        origin: { x: 0.92, y: 0.85 }
        });
    }

    // HI·ªÜU ·ª®NG ICON BAY L√äN (ƒë·ªëi v·ªõi c√¢u Likert)
    if (reactionEmoji && reactionEmoji !== "firework") {
    const zone = wrapper.querySelector(".particle-zone");

    // Random s·ªë icon: 1 ho·∫∑c 2
    const count = Math.random() > 0.5 ? 2 : 1;

    for (let i = 0; i < count; i++) {
        const e = document.createElement("div");
        e.className = "emoji-particle";
        e.textContent = reactionEmoji;

        // random tr√°i ho·∫∑c ph·∫£i
        const direction = "floatArcLeft" ;

        // nh·ªè delay ƒë·ªÉ ƒë·∫πp
        e.style.animation = `${direction} 1.1s ease-out forwards`;
        e.style.animationDelay = i * 0.1 + "s";

        zone.appendChild(e);

        setTimeout(() => e.remove(), 1600);
    }
    }


    chatEl.appendChild(wrapper);
    scrollToBottom();
    }



    /********************************************
     * Render info questions
     ********************************************/
    function renderInfo() {
      const q = infoQuestions[state.infoIndex];

      const typing = botTyping();
      setTimeout(() => {
        typing.remove();
        botMessage(`<strong>${q.question}</strong>`);

        if (q.type === "text") {
          inputArea.innerHTML = `
            <div class="mt-3 flex gap-2">
              <input id="textInput" class="flex-1 p-3 border rounded-xl" placeholder="Nh·∫≠p t·∫°i ƒë√¢y...">
              <button id="btnNext" class="px-4 py-2 bg-blue-600 text-white rounded-xl">G·ª≠i</button>
            </div>`;
          document.querySelector("#btnNext").onclick = () => {
            const val = document.querySelector("#textInput").value.trim();
            if (!val) return alert("Vui l√≤ng nh·∫≠p");
            userMessage(val, "firework");
            state.responses[q.id] = val;
            state.infoIndex++;
            inputArea.innerHTML = "";
            nextStep();
          };
        } else if (q.type === "choice") {
          inputArea.innerHTML = `
            <div class="mt-3 flex gap-2 flex-wrap">
              ${q.choices.map(
                c => `<button class="px-4 py-2 bg-white border rounded-xl hover:bg-blue-100 choiceBtn">${c}</button>`
              ).join("")}
            </div>`;
          document.querySelectorAll(".choiceBtn").forEach(btn => {
            btn.onclick = () => {
              const val = btn.textContent;
              userMessage(val, "firework");
              state.responses[q.id] = val;
              state.infoIndex++;
              inputArea.innerHTML = "";
              nextStep();

            };
          });
        }
      }, 600);
    }

    /********************************************
     * Render Likert question (with emoji)
     ********************************************/
    function renderLikert() {
      const qObj = likertQuestions[state.likertIndex];

      const typing = botTyping();
      setTimeout(() => {
        typing.remove();
        botMessage(`<strong>${qObj.group}</strong><br>${qObj.text}`);

        inputArea.innerHTML = `
          <div class="mt-3 flex gap-2 flex-wrap">
            ${[1,2,3,4,5].map(num => `
              <button class="likertBtn px-4 py-2 rounded-xl border bg-white hover:bg-blue-100">
                <div class="text-2xl">${likertEmoji[num].icon}</div>
                <div class="text-center text-xs text-slate-600">${likertEmoji[num].text}</div>
              </button>
            `).join("")}
          </div>
        `;

        document.querySelectorAll(".likertBtn").forEach((btn, index) => {
          btn.onclick = () => {
                const num = index + 1;

                // 1) L·∫•y emoji + text
                const emo = likertEmoji[num].icon;
                const emoText = likertEmoji[num].text;

                // 2) Gh√©p th√†nh c√¢u ho√†n ch·ªânh
                // V√≠ d·ª•: "T√¥i c·∫£m th·∫•y ... khi tham gia c√°c ti·∫øt h·ªçc tr√™n l·ªõp."
                const original = qObj.text;
                const finalSentence = original.replace("...", emoText.toLowerCase());

                // 3) Hi·ªÉn th·ªã c√¢u tr·∫£ l·ªùi th·∫≠t s·ª± c·ªßa h·ªçc sinh
                userMessage(`${emo} ${finalSentence}`, emo);

                // 4) L∆∞u v√†o responses d∆∞·ªõi d·∫°ng "c√¢u ho√†n ch·ªânh"
                state.responses[`q${state.likertIndex+1}`] = finalSentence;

                // 5) Chuy·ªÉn c√¢u
                state.likertIndex++;
                inputArea.innerHTML = "";
                nextStep();
          };
        });

      }, 600);
    }

    /********************************************
     * Render final message input
     ********************************************/
    function renderFinal() {
      const typing = botTyping();
      setTimeout(() => {
        typing.remove();
        botMessage(finalMessagePrompt);

        inputArea.innerHTML = `
          <div class="mt-3">
            <textarea id="finalText" rows="3" class="w-full p-3 border rounded-xl"
              placeholder="Vi·∫øt ƒëi·ªÅu b·∫°n mu·ªën chia s·∫ª..."></textarea>

            <button id="finishBtn" class="mt-3 w-full bg-blue-600 text-white py-3 rounded-xl">
              Ho√†n t·∫•t & G·ª≠i
            </button>
          </div>
        `;

        document.querySelector("#finishBtn").onclick = () => {
          const txt = document.querySelector("#finalText").value.trim();
          if (txt) userMessage(txt);
          state.responses["message"] = txt;
          inputArea.innerHTML = "";
          submitToBackend();
        };
      }, 600);
    }

    /********************************************
     * SWITCH STEP
     ********************************************/
    function nextStep() {
      if (state.step === 0) {
        if (state.infoIndex < infoQuestions.length) return renderInfo();
        state.step = 1;
        return renderLikert();
      }

      if (state.step === 1) {
        if (state.likertIndex < likertQuestions.length) return renderLikert();
        state.step = 2;
        return renderFinal();
      }
    }

    /********************************************
     * SUBMIT TO BACKEND
     ********************************************/
async function submitToBackend() {
    botMessage("Emo ƒëang l·∫Øng nghe v√† chu·∫©n b·ªã l·ªùi khuy√™n cho b·∫°n... ü§ç");

    const payload = {
        name: state.responses.name,
        class_: state.responses.class,
        gender: state.responses.gender,
        avatar: localStorage.getItem("student_avatar"),
        q1: state.responses.q1,
        q2: state.responses.q2,
        q3: state.responses.q3,
        q4: state.responses.q4,
        q5: state.responses.q5,
        q6: state.responses.q6,
        q7: state.responses.q7,
        q8: state.responses.q8,
        message: state.responses.message,
    };

    try {
        const res = await fetch("https://emomap-backend.onrender.com/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        // ‚ú® HI·ªÇN TH·ªä PH·∫¢N H·ªíI C·ª¶A AI NGAY TRONG CHAT
        botMessage(data.ai_response);

    } catch (err) {
        botMessage("Xin l·ªói, h·ªá th·ªëng ƒëang g·∫∑p l·ªói. B·∫°n th·ª≠ l·∫°i sau nh√© üíó");
        console.error(err);
    }
}


    /********************************************
     * START CHAT
     ********************************************/
    (function init(){
      const t = botTyping();
      setTimeout(() => {
        t.remove();
        botMessage("Xin ch√†o! M√¨nh l√† EmoMap ‚Äî ng∆∞·ªùi b·∫°n lu√¥n l·∫Øng nghe c·∫£m x√∫c c·ªßa b·∫°n üíô");
        setTimeout(renderInfo, 800);
      }, 800);
    })();
        function toggleChat() {
            var chatWindow = document.getElementById("myChatWindow");
            var btn = document.querySelector(".chat-btn-float");

            if (chatWindow.style.display === "none" || chatWindow.style.display === "") {
                chatWindow.style.display = "flex"; // Hi·ªán chat box
                btn.innerHTML = "‚úñ"; // ƒê·ªïi icon n√∫t th√†nh d·∫•u X
            } else {
                chatWindow.style.display = "none"; // ·∫®n chat box
                btn.innerHTML = "üí¨"; // ƒê·ªïi icon n√∫t v·ªÅ l·∫°i chat
            }
        }

// (Trong file script.js)

// 1. --- LOGIC CHUY·ªÇN TAB ---
window.switchTab = function(tabName) {
    // ·∫®n t·∫•t c·∫£ n·ªôi dung tab
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    // B·ªè class active ·ªü t·∫•t c·∫£ n√∫t
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

    // Hi·ªán tab ƒë∆∞·ª£c ch·ªçn
    document.getElementById(`tab-${tabName}`).style.display = 'flex';
    // Th√™m class active cho n√∫t ƒë∆∞·ª£c ch·ªçn (t√¨m theo text ho·∫∑c th·ª© t·ª±, ·ªü ƒë√¢y l√†m ƒë∆°n gi·∫£n)
    const btns = document.querySelectorAll('.tab-btn');
    if(tabName === 'survey') btns[0].classList.add('active');
    else {
        btns[1].classList.add('active');
        loadNotes(); // T·∫£i tin nh·∫Øn khi m·ªü tab wall
    }
}

// 2. --- LOGIC B·ª®C T∆Ø·ªúNG (D√°n v√†o cu·ªëi file ho·∫∑c trong DOMContentLoaded) ---
const BACKEND_URL = "https://emomap-backend.onrender.com"; // ƒê·∫£m b·∫£o bi·∫øn n√†y ƒë√£ c√≥

window.loadNotes = async function() {
    const wallContainer = document.getElementById('wall-container');
    try {
        const res = await fetch(`${BACKEND_URL}/get-messages`);
        const notes = await res.json();
        
        wallContainer.innerHTML = '';
        if (notes.length === 0) {
            wallContainer.innerHTML = '<p>Ch∆∞a c√≥ t√¢m s·ª± n√†o. B·∫°n h√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</p>';
            return;
        }

        notes.forEach(note => {
            const div = document.createElement('div');
            div.className = 'sticky-note';
            div.style.backgroundColor = note.emotion_color;
            div.innerText = note.content;
            
            // Xoay ng·∫´u nhi√™n nh·∫π (-3 ƒë·∫øn 3 ƒë·ªô) cho t·ª± nhi√™n
            const rotate = Math.floor(Math.random() * 6) - 3;
            div.style.transform = `rotate(${rotate}deg)`;
            
            wallContainer.appendChild(div);
        });
    } catch (e) {
        console.error(e);
        wallContainer.innerHTML = '<p style="color:red">L·ªói t·∫£i d·ªØ li·ªáu :(</p>';
    }
}

window.postNote = async function() {
    const input = document.getElementById('noteInput');
    const content = input.value.trim();
    const btn = document.querySelector('.btn-post');

    if(!content) return alert("B·∫°n ch∆∞a vi·∫øt g√¨ c·∫£!");
    if(content.length > 300) return alert("T√¢m s·ª± d√†i qu√°, h√£y t√≥m t·∫Øt d∆∞·ªõi 300 k√Ω t·ª± nh√©!");

    btn.disabled = true;
    btn.innerText = "ƒêang d√°n...";

    try {
        const res = await fetch(`${BACKEND_URL}/post-message`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content: content})
        });

        if(!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "L·ªói server");
        }

        input.value = '';
        alert("ƒê√£ d√°n l√™n t∆∞·ªùng th√†nh c√¥ng!");
        loadNotes(); // T·∫£i l·∫°i ngay
    } catch (e) {
        alert("Kh√¥ng th·ªÉ g·ª≠i: " + e.message);
    } finally {
        btn.disabled = false;
        btn.innerText = "D√°n l√™n t∆∞·ªùng";
    }
}
  </script>

</body>
</html>
