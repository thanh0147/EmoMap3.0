<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EmoMap — Dashboard</title>
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/763/763755.png">
  <meta property="og:title" content="EmoMap AI" />
  <meta property="og:description" content="EmoMap - Hệ thống AI tương tác hỗ trợ sàng lọc sớm bạo lực học đường trong trường THPT" />
  <meta property="og:image" content="https://i.ibb.co/q3ymzcdJ/Th-m-ti-u-ph-1.png" />
  <meta property="og:url" content="https://emomap.onrender.com/" />
  <meta property="og:type" content="Website KHKT" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}</style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-sky-50 to-indigo-50 min-h-screen">
  <div class="max-w-7xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-white text-2xl font-bold"><img src="https://cdn-icons-png.flaticon.com/512/763/763755.png"  alt=""></div>
        <div>
          <h1 class="text-2xl font-bold text-slate-800">EmoMap — Dashboard</h1>
          <p class="text-sm text-slate-500">Giám sát cảm xúc học đường — quản trị viên</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="refreshBtn" class="px-4 py-2 bg-white border rounded-lg shadow">Làm mới</button>
        <a href="chat.html" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow">Mở trò chuyện</a>
      </div>
    </header>

    <!-- Summary cards -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="p-4 bg-white rounded-xl shadow">
        <div class="text-sm text-slate-500">Tổng bản ghi</div>
        <div id="totalRecords" class="text-2xl font-semibold text-slate-800">—</div>
      </div>
      <div class="p-4 bg-white rounded-xl shadow">
        <div class="text-sm text-slate-500">Nguy cơ cao (≥70)</div>
        <div id="highRisk" class="text-2xl font-semibold text-red-600">—</div>
      </div>
      <div class="p-4 bg-white rounded-xl shadow">
        <div class="text-sm text-slate-500">Nguy cơ trung bình (40–69)</div>
        <div id="midRisk" class="text-2xl font-semibold text-amber-600">—</div>
      </div>
      <div class="p-4 bg-white rounded-xl shadow">
        <div class="text-sm text-slate-500">Điểm trung bình</div>
        <div id="avgRisk" class="text-2xl font-semibold text-slate-800">—</div>
      </div>
    </section>

    <!-- Charts + Filters -->
    <section class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
      <div class="lg:col-span-3 p-4 bg-white rounded-xl shadow">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Biểu đồ cảm xúc theo thời gian</h2>
          <div class="flex items-center gap-2">
            <label class="text-sm text-slate-600">Gộp theo</label>
            <select id="groupBy" class="p-2 border rounded">
              <option value="day">Ngày</option>
              <option value="week">Tuần</option>
              <option value="month">Tháng</option>
            </select>
          </div>
        </div>
        <canvas id="emotionChart" height="140"></canvas>
      </div>

      <aside class="p-4 bg-white rounded-xl shadow">
        <h2 class="text-lg font-semibold mb-3">Bộ lọc nhanh</h2>
        <div class="space-y-3">
          <div>
            <label class="text-sm text-slate-600">Lớp</label>
            <input id="filterClass" type="text" placeholder="vd: 10A1" class="mt-1 w-full p-2 border rounded" />
          </div>
          <div>
            <label class="text-sm text-slate-600">Giới tính</label>
            <select id="filterGender" class="mt-1 w-full p-2 border rounded">
              <option value="">Tất cả</option>
              <option>Nam</option>
              <option>Nữ</option>
              <option>Khác</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-slate-600">Ngưỡng nguy cơ</label>
            <input id="filterRisk" type="range" min="0" max="100" value="70" class="w-full">
            <div class="flex justify-between text-xs text-slate-500"><span>0</span><span>100</span></div>
            <div class="text-sm mt-1">Hiển thị học sinh có risk ≥ <span id="riskVal">70</span></div>
          </div>
          <div class="flex gap-2 mt-3">
            <button id="applyFilter" class="px-3 py-2 bg-blue-600 text-white rounded">Áp dụng</button>
            <button id="clearFilter" class="px-3 py-2 bg-gray-200 rounded">Xóa</button>
          </div>
        </div>
      </aside>
    </section>

    <!-- Data table -->
    <section class="bg-white rounded-xl shadow p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Danh sách phản hồi</h3>
        <div class="flex items-center gap-2">
          <input id="searchBox" type="text" placeholder="Tìm tên / lớp / nội dung" class="p-2 border rounded" />
          <button id="exportCsv" class="px-3 py-2 bg-green-600 text-white rounded">Xuất CSV</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table id="dataTable" class="min-w-full text-left">
          <thead>
            <tr class="text-sm text-slate-500">
              <th class="p-2">#</th>
              <th class="p-2">Tên</th>
              <th class="p-2">Lớp</th>
              <th class="p-2">Giới tính</th>
              <th class="p-2">Risk</th>
              <th class="p-2">Ngày</th>
              <th class="p-2">Tâm sự</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>

    <footer class="mt-6 text-sm text-slate-500">EmoMap • Hệ thống sàng lọc cảm xúc học đường</footer>
  </div>

<script>
const API_BASE = "https://emomap-backend.onrender.com"

// Elements
const totalRecordsEl = document.getElementById('totalRecords');
const highRiskEl = document.getElementById('highRisk');
const midRiskEl = document.getElementById('midRisk');
const avgRiskEl = document.getElementById('avgRisk');
const riskVal = document.getElementById('riskVal');
const filterRisk = document.getElementById('filterRisk');
const applyFilter = document.getElementById('applyFilter');
const clearFilter = document.getElementById('clearFilter');
const filterClass = document.getElementById('filterClass');
const filterGender = document.getElementById('filterGender');
const tableBody = document.getElementById('tableBody');
const searchBox = document.getElementById('searchBox');
const exportCsvBtn = document.getElementById('exportCsv');
const refreshBtn = document.getElementById('refreshBtn');
const groupBy = document.getElementById('groupBy');

let rawData = [];
let emotionChart;

filterRisk.addEventListener('input', () => { riskVal.innerText = filterRisk.value; });
applyFilter.addEventListener('click', renderTableWithFilters);
clearFilter.addEventListener('click', () => { filterClass.value=''; filterGender.value=''; filterRisk.value=70; riskVal.innerText='70'; renderTableWithFilters(); });
refreshBtn.addEventListener('click', fetchAll);
searchBox.addEventListener('input', renderTableWithFilters);
exportCsvBtn.addEventListener('click', exportCsv);
groupBy.addEventListener('change', () => renderChartWithGrouping());

async function fetchAll(){
  try{
    const summaryRes = await fetch(API_BASE + '/dashboard/summary');
    const summary = await summaryRes.json();
    totalRecordsEl.innerText = summary.total_records;
    highRiskEl.innerText = summary.high_risk;
    midRiskEl.innerText = summary.medium_risk;
    avgRiskEl.innerText = summary.avg_risk;

    rawData = await (await fetch(API_BASE + '/dashboard/all')).json();

    renderChartWithGrouping();
    renderTableWithFilters();
  }catch(e){
    console.error('fetch error', e);
    alert('Không thể lấy dữ liệu từ backend. Kiểm tra CORS và API endpoints.');
  }
}

function groupByPeriod(data, period){
  // returns { label: string, avgRisk: number, count }
  const map = new Map();
  data.forEach(r => {
    const d = new Date(r.created_at);
    if(isNaN(d)) return;
    let key;
    if(period==='day'){
      key = d.toISOString().slice(0,10); // YYYY-MM-DD
    } else if(period==='week'){
      // ISO week representation: year-Www
      const year = d.getFullYear();
      const week = getWeekNumber(d);
      key = `${year}-W${String(week).padStart(2,'0')}`;
    } else {
      key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; // YYYY-MM
    }
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(r.risk||0);
  });

  const out = [];
  Array.from(map.keys()).sort().forEach(k => {
    const arr = map.get(k);
    const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
    out.push({ label: k, avg: Math.round(avg*100)/100, count: arr.length });
  });
  return out;
}

function getWeekNumber(d) {
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  return Math.ceil((((date - yearStart) / 86400000) + 1)/7);
}

function renderChartWithGrouping(){
  const period = groupBy.value; // day/week/month
  const grouped = groupByPeriod(rawData, period);
  const labels = grouped.map(x => x.label);
  const dataPoints = grouped.map(x => x.avg);

  // Bar colors based on value
  const bg = dataPoints.map(v => v>=70? 'rgba(239,68,68,0.9)': (v>=40? 'rgba(251,146,60,0.9)' : 'rgba(59,130,246,0.9)'));

  const ctx = document.getElementById('emotionChart').getContext('2d');
  if(emotionChart) emotionChart.destroy();

  emotionChart = new Chart(ctx, {
    data: {
      labels,
      datasets: [
        {
          type: 'bar',
          label: 'Điểm trung bình (theo '+period+')',
          data: dataPoints,
          backgroundColor: bg,
          borderWidth: 0
        },
        {
          type: 'line',
          label: 'Đường trung bình (trend)',
          data: dataPoints,
          borderColor: 'rgba(15,23,42,0.9)',
          borderWidth: 2,
          tension: 0.3,
          fill: false,
          pointRadius: 3
        }
      ]
    },
    options: {
      responsive:true,
      interaction: { mode: 'index', intersect: false },
      scales: {
        y: { beginAtZero:true, max:100 }
      }
    }
  });
}

function renderTableWithFilters(){
  const cls = filterClass.value.trim().toLowerCase();
  const gender = filterGender.value;
  const minRisk = Number(filterRisk.value);
  const search = searchBox.value.trim().toLowerCase();

  const filtered = rawData.filter((r) => {
    if(cls && !((r.class||'').toLowerCase().includes(cls))) return false;
    if(gender && r.gender !== gender) return false;
    if((r.risk||0) < minRisk) return false;
    if(search){
      const s = (r.name||'') + ' ' + (r.class||'') + ' ' + (r.message||'');
      if(!s.toLowerCase().includes(search)) return false;
    }
    return true;
  });

  tableBody.innerHTML = '';
  filtered.forEach((r, idx) => {
    const tr = document.createElement('tr');
    const risk = r.risk || 0;
    const riskColor = risk >= 70 ? 'bg-red-50' : (risk>=40 ? 'bg-amber-50' : '');
    tr.className = riskColor + ' align-top border-b';
    tr.innerHTML = `
      <td class="p-2 text-sm">${idx+1}</td>
      <td class="p-2 text-sm">${escapeHtml(r.name||'')}</td>
      <td class="p-2 text-sm">${escapeHtml(r.class||'')}</td>
      <td class="p-2 text-sm">${escapeHtml(r.gender||'')}</td>
      <td class="p-2 text-sm font-semibold">${risk}</td>
      <td class="p-2 text-sm">${new Date(r.created_at).toLocaleString()}</td>
      <td class="p-2 text-sm">${escapeHtml(r.message||'')}</td>
    `;
    tableBody.appendChild(tr);
  });
}

function escapeHtml(s){ return String(s||'').replace(/[&<>\\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

function exportCsv() {
  if (!rawData || rawData.length === 0) {
    alert("Không có dữ liệu để xuất.");
    return;
  }

  // 1) Tên cột hiển thị đẹp
  const headers = [
    "STT",
    "Tên học sinh",
    "Lớp",
    "Giới tính",
    "Điểm Risk",
    "Ngày ghi nhận",
    "Tâm sự"
  ];

  // 2) Dữ liệu từng dòng
  const rows = rawData.map((r, idx) => {
    const cleanMessage = (r.message || "")
      .replace(/\r?\n|\r/g, " ")       // bỏ xuống dòng
      .replace(/"/g, '""');            // escape dấu "

    return [
      idx + 1,
      r.name || "",
      r.class || "",
      r.gender || "",
      r.risk || 0,
      new Date(r.created_at).toLocaleString("vi-VN"),
      cleanMessage
    ];
  });

  // 3) Tạo CSV string
  let csvContent =
    "\uFEFF" + // BOM UTF-8 để hiển thị tiếng Việt đúng trên Excel
    headers.join(",") +
    "\n" +
    rows.map(row => row.map(v => `"${v}"`).join(",")).join("\n");

  // 4) Tạo file CSV để tải xuống
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.setAttribute("href", url);
  link.setAttribute("download", "emomap_export.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}


// Init
fetchAll();
</script>
</body>
</html>
